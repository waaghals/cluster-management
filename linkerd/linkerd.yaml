apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: linkerd
  namespace: argocd
spec:
  generators:
    - clusters: {} # All clusters
  template:
    metadata:
      name: linkerd-{{name}}
    spec:
      project: service-mesh
      source:
        chart: linkerd2
        repoURL: https://helm.linkerd.io/stable
        targetRevision: 2.11.0
        helm:
          values: |
            identity:
              externalCA: true
              issuer:
                scheme: kubernetes.io/tls
            installNamespace: false
            proxyInit:
              runAsRoot: true
      ignoreDifferences:
        - group: ""
          kind: Secret
          name:  linkerd-proxy-injector-k8s-tls
          jsonPointers:
            - /data/tls.crt
            - /data/tls.key
        - group: ""
          kind: Secret
          name:  linkerd-sp-validator-k8s-tls
          jsonPointers:
            - /data/tls.crt
            - /data/tls.key
        - group: ""
          kind: Secret
          name:  linkerd-tap-k8s-tls
          jsonPointers:
            - /data/tls.crt
            - /data/tls.key
        - group: admissionregistration.k8s.io/v1
          kind: MutatingWebhookConfiguration
          name:  linkerd-proxy-injector-webhook-config
          jsonPointers:
            - /webhooks/0/clientConfig/caBundle
        - group: admissionregistration.k8s.io/v1
          kind: ValidatingWebhookConfiguration
          name:  linkerd-sp-validator-webhook-config
          jsonPointers:
            - /webhooks/0/clientConfig/caBundle
        - group: apiregistration.k8s.io/v1
          kind: APIService
          name: v1alpha1.tap.linkerd.io
          jsonPointers:
            - /spec/caBundle
      destination:
        server: '{{server}}'
        namespace: linkerd
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        # let manifests create the namespace, to be sure that those manifests are deployed earlier
        syncOptions:
          - CreateNamespace=false
